<!DOCTYPE html>
<html lang="es">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TP</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body data-bs-theme="dark">
    <div class="header">
      <h1>Peliculas</h1>
    </div>
    
    <div id="form_nueva_pelicula">
    </div>

    <h3>Nueva Reseña</h3>

    <form onsubmit="sendReseña(event)">
      <div class="contenedor-input">
        <label>
          Pelicula <span class="req">*</span>
        </label>
        <select name="id_pelicula" id="pelicula-select" onChange="loadFormMovie(false)" required>
          <option value="">--Please choose an option--</option>
        </select>
        <span onclick="loadFormMovie(true)">Cargar nueva pelicula</span>
      </div>
      
      <div class="contenedor-input">
        <label>
          Puntaje <span class="req">*</span>
        </label>
        <input type="text" name="puntaje" required>
      </div>

      <div class="contenedor-input">
        <label>
          Reseña <span class="req">*</span>
        </label>
        <input type="text" name="reseña_corta" required>
      </div>

      <input type="submit" class="" value="Iniciar Sesión">
      <a href="/">
        <input type="button" value="cancel" />
      </a>
    </form>

    <script>
      if(!localStorage.getItem("userId")){
        window.location.replace("http://localhost:8000/login");
      }
      loadMoviesOptions();
      let base64String = "";
    
      function loadFormMovie(activeForm){
        const selectPelicula = document.getElementById("pelicula-select");
        const container = document.getElementById("form_nueva_pelicula");
        if(activeForm){
          selectPelicula.selectedIndex = 0;
          container.innerHTML = `
          <h3>Nueva Pelicula</h3>
          <form onsubmit="sendPelicula(event)">
            <div class="contenedor-input">
              <label>
                nombre <span class="req">*</span>
              </label>
              <input name="nombre" type="text">
            </div>
            <div class="contenedor-input">
              <label>
                director <span class="req">*</span>
              </label>
              <input name="director" type="text">
            </div>
            <div class="contenedor-input">
              <label>
                año de estreno <span class="req">*</span>
              </label>
              <input name="año_estreno" type="number">
            </div>
            <div class="contenedor-input">
              <label>
                genero <span class="req">*</span>
              </label>
              <input name="genero" type="text">
            </div>
            <div class="contenedor-input">
              <label>
                imagen <span class="req">*</span>
              </label>
              <input type="file" accept="image/*" name="imagen" onchange="imageUploaded()">
            </div>
            <input type="submit" value="Cargar pelicula">
            <input type="button" value="Cancel"  onClick="loadFormMovie(false)">
          </form>`
        }else{
          container.innerHTML =""
        }
      }

      function resizeImage(base64Str, maxWidth = 400, maxHeight = 350) {
        return new Promise((resolve) => {
          let img = new Image()
          img.src = base64Str
          img.onload = () => {
            let canvas = document.createElement('canvas')
            const MAX_WIDTH = maxWidth
            const MAX_HEIGHT = maxHeight
            let width = img.width
            let height = img.height

            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width
                width = MAX_WIDTH
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height
                height = MAX_HEIGHT
              }
            }
            canvas.width = width
            canvas.height = height
            let ctx = canvas.getContext('2d')
            ctx.drawImage(img, 0, 0, width, height)
            resolve(canvas.toDataURL())
          }
        })
      }

      function imageUploaded() {
        let file = document.querySelector('input[type=file]')['files'][0];

        let reader = new FileReader();
        

        reader.onload = function () {
          resizeImage(reader.result, 100, 100).then((result) => {
            base64String = result;
          });
        }
        reader.readAsDataURL(file);
      }
      
      

      function response_received(response) {
        return response.json()
      }

      function parse_data(content) {
        const container = document.getElementById("pelicula-select");
        for (let index = 0; index < content.length; index++) {
          console.log(content[index])
          const item = document.createElement("option");
          item.setAttribute("value", content[index].id);
          item.innerHTML = content[index].año_estreno + " - " + content[index].nombre + " - " + content[index].director
          container.append(item);
        }
      }

      function request_error(error) {
        console.log("ERROR")
        console.log(error);
      }
      
      function loadMoviesOptions(){
        fetch("http://localhost:5000/peliculas") 
        .then(response_received)   
        .then(parse_data)       
        .catch(request_error)
      }
                
      const sendPelicula = (e) => {
        console.log(base64String.length)
        e.preventDefault();
        const formData = new FormData(e.target);
        const formProps = Object.fromEntries(formData);
        let data = {
          ...formProps,
          imagen: base64String,
        }
        console.log(data)
        fetch('http://localhost:5000/peliculas', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(Result => Result.json())
        .then(data => {
          loadMoviesOptions();
          loadFormMovie(false)
          // your code comes here
        })
        .catch(errorMsg => {
          console.log(errorMsg);
        });
      };

      const sendReseña = (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const formProps = Object.fromEntries(formData);
        let data = {
          ...formProps,
          id_usuario: localStorage.getItem("userId"),
        }
        fetch('http://localhost:5000/reseñas', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(Result => Result.json())
        .then(data => {
          console.log(data);    
          // your code comes here
        })
        .catch(errorMsg => {
          console.log(errorMsg);
        });
      };
    </script>
  </body>
</html>